<?xml version="1.0"?>

<!-- $Id$ -->

<!-- ==========================================================================

Module              : ant
Module-Dependencies : build, main

This build script is part of the Jalopy build system. It is not meant to be
directly invoked by the user but should only be used in conjunction with the
master build script that controls the whole build process.

For detailed instructions on how to obtain the needed modules and build a
Jalopy distribution from scratch please refer to the manual available at the
official Jalopy homepage under <http://jalopy.sf.net/build.html>.

If you need further assistance, check <http://jalopy.sf.net/contact.html>.

=========================================================================== -->

<project name="jalopy-ant" default="ant-jar" basedir="." >

  <!-- load the global properties -->
  <property file="../build/build.properties" />

  <property name="dir.src" value="src" />
  <property name="dir.src.java" value="${dir.src}/java" />
  <property name="dir.src.res" value="${dir.src}/resources" />

  <!-- ==================================================================== -->
  <!-- Defines the project classpath                                        -->
  <!-- ==================================================================== -->
  <path id="project.classpath" >
    <fileset dir="${DIR.LIB}" >
      <include name="*.jar" />
    </fileset>
    <pathelement path="${LIB.PATH.ANT}" />
    <pathelement path="${DIR.COMPILE}" />
  </path>


  <!-- ==================================================================== -->
  <!-- Creates the binary Ant Plug-in .jar                                  -->
  <!-- ==================================================================== -->
  <target name="ant-jar"
          description="Creates the Ant .jar"
          depends="ant-compile, ant-uptodate-jar"
          unless="jar.ant.uptodate" >
    <property name="jar.name" value="jalopy-ant" />

    <jar jarfile="${DIR.JARS}/${jar.name}-${BUILD.VERSION.ANT}.jar"
         duplicate="fail"
         index="false" >
      <fileset dir="${DIR.COMPILE}" >
        <include name="**/plugin/ant/**" />
      </fileset>
      <manifest>
        <attribute name="Class-Path" value="jalopy-${BUILD.VERSION}.jar jdom-${LIB.VERSION.JDOM}.jar log4j-${LIB.VERSION.LOG4J}.jar oro-${LIB.VERSION.ORO}.jar" />
        <section name="de/hunsicker/jalopy/plugin/ant/">
          <attribute name="Specification-Title" value="Jalopy Java Source Code Formatter" />
          <attribute name="Specification-Version" value="${SPEC.VERSION.ANT}" />
          <attribute name="Specification-Vendor" value="${AUTHOR.NAME}" />
          <attribute name="Implementation-Title" value="de.hunsicker.jalopy.plugin.ant" />
          <attribute name="Implementation-Version" value="${BUILD.VERSION.ANT}" />
          <attribute name="Implementation-Vendor" value="${AUTHOR.NAME}" />
          <attribute name="Implementation-URL" value="${HOMEPAGE}" />
        </section>
      </manifest>
    </jar>
  </target>


  <!-- ==================================================================== -->
  <!-- Compiles the project sources                                         -->
  <!-- ==================================================================== -->
  <target name="ant-compile"
          depends="ant-init" >
    <javac compiler="${BUILD.COMPILER}"
           destdir="${DIR.COMPILE}"
           debug="${BUILD.DEBUG}"
           deprecation="${BUILD.DEPRECATION}"
           optimize="${BUILD.OPTIMIZE}"
           target="${BUILD.TARGET.VM}"
           verbose="${BUILD.VERBOSE}"
           fork="true" >
      <classpath refid="project.classpath" />
      <src path="${dir.src.java}" />
    </javac>
  </target>


  <!-- ==================================================================== -->
  <!-- Formats the project sources                                          -->
  <!-- ==================================================================== -->
  <target name="ant-format" depends="ant-compile">

    <!-- declare the Jalopy task -->
    <taskdef name="jalopy"
             classname="de.hunsicker.jalopy.plugin.ant.AntPlugin">
      <classpath refid="project.classpath" />
    </taskdef>

    <jalopy classpathref="project.classpath"
            style="${dir.src.res}/jal-bsd.xml">
      <fileset dir="${dir.src.java}">
        <include name="**/*.java" />
      </fileset>
    </jalopy>
  </target>


  <!-- ==================================================================== -->
  <!-- Initializes the build                                                -->
  <!-- ==================================================================== -->
  <target name="ant-init"
          depends="ant-check-modules" >
    <native2ascii
        src="${dir.src.java}"
        dest="${DIR.COMPILE}"
        includes="**/Bundle*.properties" />
  </target>


  <!-- ==================================================================== -->
  <!-- Checks whether all module dependencies are satisfied                 -->
  <!-- ==================================================================== -->
  <target name="ant-check-modules" unless="ant.check.modules">
    <available file="../build/build.xml" property="present.build" />
    <antcall target="ant-check-build" />

    <!-- now we know module 'build' exists so we can use its targets -->
    <ant dir="../build" target="build-check-main" inheritAll="false" />

    <!-- build the runtime .jar if necessary -->
    <ant dir="../main" target="main-jar" inheritAll="false" />

    <property name="ant.check.modules" value="true" />
  </target>


  <!-- ==================================================================== -->
  <!-- Checks whether the module 'build' exists                             -->
  <!-- ==================================================================== -->
  <target name="ant-check-build"
          unless="present.build" >
    <echo message="ERROR 10: Module 'build' not found" />
    <echo message="" />
    <echo message="Please refer to ${ant.file}" />
    <echo message="on how to obtain the needed module." />
    <fail message="Module 'build' not found" />
  </target>


  <!-- ==================================================================== -->
  <!-- Checks whether the .jar needs to be generated                        -->
  <!-- ==================================================================== -->
  <target name="ant-uptodate-jar" >
    <dependset>
      <srcfileset dir="${DIR.COMPILE}">
        <include name="*" />
        <include name="de/hunsicker/io/*" />
        <include name="de/hunsicker/jalopy/*" />
        <include name="de/hunsicker/jalopy/language/*" />
        <include name="de/hunsicker/jalopy/plugin/*" />
        <include name="de/hunsicker/jalopy/prefs/*" />
        <include name="de/hunsicker/jalopy/printer/*" />
        <include name="de/hunsicker/jalopy/swing/*" />
        <include name="de/hunsicker/swing/*" />
        <include name="de/hunsicker/swing/util/*" />
        <include name="de/hunsicker/util/*" />
        <include name="de/hunsicker/util/concurrent/*" />
        <include name="de/hunsicker/jalopy/plugin/ant/*" />
      </srcfileset>
      <srcfileset dir="${DIR.JARS}">
        <include name="jalopy-${BUILD.VERSION}.jar" />
      </srcfileset>
      <srcfileset dir="..\build">
        <include name="build.xml" />
        <include name="build.properties" />
      </srcfileset>
      <srcfileset dir="${basedir}">
        <include name="build.xml" />
      </srcfileset>
      <targetfileset dir="${DIR.JARS}"
                     includes="jalopy-ant-${BUILD.VERSION.ANT}.jar"/>
    </dependset>

    <available property="jar.ant.uptodate"
               file="${DIR.JARS}/jalopy-ant-${BUILD.VERSION.ANT}.jar" />
  </target>
</project>